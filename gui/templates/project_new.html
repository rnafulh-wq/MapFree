{% extends "base.html" %}
{% block title %}MapFree â€” New Project{% endblock %}
{% block content %}
<section class="flex-1 overflow-y-auto bg-surface-dark p-8">
    <div class="max-w-xl mx-auto space-y-6">
        <h2 class="text-xl font-semibold text-white flex items-center gap-2">
            <span class="material-symbols-outlined text-primary">add_circle</span>
            New Project
        </h2>
        <div>
            <label class="text-sm font-medium text-text-main block mb-2">Project Name</label>
            <input type="text" class="w-full rounded bg-surface-lighter border border-border-dark text-white py-2 px-4" placeholder="My Project"/>
        </div>
        <div>
            <label class="text-sm font-medium text-text-main block mb-2">Image Folder</label>
            <div class="flex gap-2 items-stretch min-w-0">
                <input type="text" id="project-image-folder" class="flex-1 min-w-0 rounded bg-surface-lighter border border-border-dark text-white py-2 px-4" placeholder="/path/to/images"/>
                <button type="button" class="project-browse-btn shrink-0 px-4 py-2 rounded-lg bg-primary/20 border border-primary/50 text-primary hover:bg-primary hover:text-white transition-colors flex items-center gap-2 font-medium text-sm" data-target="project-image-folder" title="Pilih folder gambar">
                    <span class="material-symbols-outlined text-xl">folder_open</span>
                    <span>Browse</span>
                </button>
            </div>
        </div>
        <div>
            <label class="text-sm font-medium text-text-main block mb-2">Output Folder</label>
            <div class="flex gap-2 items-stretch min-w-0">
                <input type="text" id="project-output-folder" class="flex-1 min-w-0 rounded bg-surface-lighter border border-border-dark text-white py-2 px-4" placeholder="/path/to/output"/>
                <button type="button" class="project-browse-btn shrink-0 px-4 py-2 rounded-lg bg-primary/20 border border-primary/50 text-primary hover:bg-primary hover:text-white transition-colors flex items-center gap-2 font-medium text-sm" data-target="project-output-folder" title="Pilih folder output">
                    <span class="material-symbols-outlined text-xl">folder_open</span>
                    <span>Browse</span>
                </button>
            </div>
        </div>
        <div class="flex gap-3 pt-4">
            <a href="{{ url_for('dashboard') }}" class="px-5 py-2 rounded text-sm font-medium text-text-muted border border-border-dark hover:bg-surface-lighter">Cancel</a>
            <a href="{{ url_for('dashboard') }}" class="px-5 py-2 rounded text-sm font-medium bg-primary text-white hover:bg-primary-hover">Create Project</a>
        </div>
    </div>
</section>
{% endblock %}
{% block scripts %}
<script>
(function() {
    function log(msg, level) {
        if (typeof window.appendConsoleLog === 'function') window.appendConsoleLog(msg, level || 'info');
    }
    function initBrowseButtons() {
        document.querySelectorAll('.project-browse-btn').forEach(function(btn) {
            if (btn._bound) return;
            btn._bound = true;
            btn.addEventListener('click', function() {
                var targetId = btn.getAttribute('data-target');
                var input = targetId ? document.getElementById(targetId) : null;
                log('Membuka jendela pilih folder...', 'info');
                if (typeof pywebview === 'undefined' || !pywebview.api) {
                    log('API pywebview tidak tersedia. Jalankan aplikasi desktop: python -m gui.main', 'warn');
                    if (input) input.placeholder = 'Jalankan app desktop untuk memilih folder';
                    return;
                }
                if (typeof pywebview.api.select_folder !== 'function') {
                    log('select_folder tidak tersedia. Pastikan jendela dibuka dengan pywebview.', 'error');
                    return;
                }
                var promise = pywebview.api.select_folder();
                if (!promise || typeof promise.then !== 'function') {
                    log('Panggilan select_folder gagal (bukan Promise).', 'error');
                    return;
                }
                promise.then(function(path) {
                    if (path && input) {
                        input.value = path;
                        if (input.id === 'project-image-folder') try { sessionStorage.setItem('mapfree_image_folder', path); } catch (_) {}
                        if (input.id === 'project-output-folder') try { sessionStorage.setItem('mapfree_output_folder', path); } catch (_) {}
                        log('Folder dipilih: ' + path, 'success');
                    } else if (!path) {
                        log('Pemilihan folder dibatalkan.', 'info');
                    }
                }).catch(function(err) {
                    var msg = (err && err.message) ? err.message : String(err);
                    log('Dialog folder: ' + msg, 'error');
                });
            });
        });
    }
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initBrowseButtons);
    } else {
        initBrowseButtons();
    }
    window.addEventListener('pywebviewready', initBrowseButtons);
    // Persist folder paths to sessionStorage for Start Processing on dashboard
    var imgInput = document.getElementById('project-image-folder');
    var outInput = document.getElementById('project-output-folder');
    if (imgInput) imgInput.addEventListener('change', function() { try { sessionStorage.setItem('mapfree_image_folder', imgInput.value); } catch (_) {} });
    if (outInput) outInput.addEventListener('change', function() { try { sessionStorage.setItem('mapfree_output_folder', outInput.value); } catch (_) {} });
})();
</script>
{% endblock %}
