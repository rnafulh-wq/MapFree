{% extends "base.html" %}
{% block title %}MapFree — Dashboard{% endblock %}
{% block content %}
<!-- Center Viewport -->
<section class="flex-1 relative bg-[#1a1a1a] flex flex-col min-w-0">
    <div class="absolute top-4 left-4 z-10 flex flex-col gap-2">
        <div class="bg-surface-dark/90 backdrop-blur border border-white/10 rounded-lg shadow-lg flex flex-col p-1">
            <button class="p-2 text-white hover:bg-white/10 rounded" title="Select"><span class="material-symbols-outlined text-[20px]">arrow_selector_tool</span></button>
            <button class="p-2 text-white hover:bg-white/10 rounded" title="Rotate"><span class="material-symbols-outlined text-[20px]">3d_rotation</span></button>
            <button class="p-2 text-white hover:bg-white/10 rounded" title="Pan"><span class="material-symbols-outlined text-[20px]">pan_tool</span></button>
            <button class="p-2 text-white hover:bg-white/10 rounded" title="Measure"><span class="material-symbols-outlined text-[20px]">straighten</span></button>
            <div class="h-px bg-white/10 my-1"></div>
            <button class="p-2 text-primary bg-primary/20 rounded" title="Reset View"><span class="material-symbols-outlined text-[20px]">center_focus_strong</span></button>
        </div>
    </div>
    <div class="absolute top-4 right-4 z-10">
        <div class="bg-surface-dark/90 backdrop-blur border border-white/10 rounded-lg shadow-lg flex p-1">
            <button class="px-3 py-1.5 text-xs font-medium text-text-muted hover:text-white hover:bg-white/10 rounded">Points</button>
            <button class="px-3 py-1.5 text-xs font-medium text-white bg-primary/20 text-primary border border-primary/30 rounded">Cloud</button>
            <button class="px-3 py-1.5 text-xs font-medium text-text-muted hover:text-white hover:bg-white/10 rounded">Mesh</button>
            <button class="px-3 py-1.5 text-xs font-medium text-text-muted hover:text-white hover:bg-white/10 rounded">Textured</button>
        </div>
    </div>
    <div class="w-full h-full relative overflow-hidden">
        <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-[#2a2a2a] to-[#111111]"></div>
        <div class="absolute inset-0 opacity-20" style="background-image: linear-gradient(#444 1px, transparent 1px), linear-gradient(90deg, #444 1px, transparent 1px); background-size: 40px 40px;"></div>
        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
            <div class="w-4 h-4 border border-white/30 rounded-full"></div>
        </div>
        <div class="absolute bottom-8 left-8 w-16 h-16 pointer-events-none">
            <div class="absolute bottom-0 left-0 w-12 h-0.5 bg-red-500"></div>
            <div class="absolute bottom-0 left-0 w-0.5 h-12 bg-green-500"></div>
            <span class="absolute bottom-1 right-2 text-[10px] text-red-500 font-bold">X</span>
            <span class="absolute top-2 left-2 text-[10px] text-green-500 font-bold">Y</span>
        </div>
    </div>
</section>
<!-- Right Sidebar: Processing Settings -->
<aside class="w-80 bg-surface-dark border-l border-border-dark flex flex-col shrink-0 z-10 shadow-xl">
    <div class="p-4 border-b border-border-dark">
        <h2 class="text-sm font-semibold text-white">Processing Settings</h2>
        <p class="text-xs text-text-muted mt-1">Configure parameters for the current step.</p>
    </div>
    <div class="flex-1 overflow-y-auto p-4 space-y-6">
        <div class="space-y-3">
            <div class="flex items-center justify-between">
                <h3 class="text-xs font-bold uppercase tracking-wider text-text-muted">Alignment</h3>
                <span class="text-[10px] text-green-500 border border-green-500/30 px-1.5 rounded bg-green-500/10">Done</span>
            </div>
        </div>
        <div class="space-y-3 relative">
            <div class="flex items-center justify-between">
                <h3 class="text-xs font-bold uppercase tracking-wider text-white">Dense Cloud</h3>
                <span class="text-[10px] text-primary border border-primary/30 px-1.5 rounded bg-primary/10">Ready</span>
            </div>
            <div class="space-y-2">
                <label class="text-xs text-text-muted block">Quality <span id="dashboard-quality-label" class="text-primary">Medium</span></label>
                <input id="dashboard-quality" class="w-full h-1 bg-surface-lighter rounded-lg appearance-none cursor-pointer accent-primary" type="range" min="1" max="3" value="2" title="1=High, 2=Medium, 3=Low"/>
                <p id="dashboard-quality-recommend" class="text-[10px] text-text-muted">Smart scaling: checking VRAM…</p>
            </div>
        </div>
    </div>
    <div class="p-4 bg-[#2a2a2a] border-t border-border-dark">
        <button type="button" id="start-processing-btn" class="w-full flex items-center justify-center gap-2 bg-primary text-white py-2.5 rounded-lg text-sm font-bold hover:bg-primary-hover shadow-lg shadow-primary/20">
            <span class="material-symbols-outlined text-lg">play_arrow</span>
            Start Processing
        </button>
    </div>
</aside>
{% endblock %}
{% block scripts %}
<script>
(function() {
    var qualityMap = { 1: 'high', 2: 'medium', 3: 'low' };
    var qualityToSlot = { high: 1, medium: 2, low: 3 };
    var qualityLabels = { 1: 'High', 2: 'Medium', 3: 'Low' };
    var qualityInput = document.getElementById('dashboard-quality');
    var qualityLabel = document.getElementById('dashboard-quality-label');
    var recommendEl = document.getElementById('dashboard-quality-recommend');
    function setQualityUI(slot, label, save) {
        if (qualityInput) qualityInput.value = String(slot);
        if (qualityLabel) qualityLabel.textContent = label || qualityLabels[slot];
        if (save) try { sessionStorage.setItem('mapfree_quality', qualityMap[slot] || 'medium'); } catch (_) {}
    }
    if (qualityInput) {
        qualityInput.addEventListener('input', function() {
            var v = parseInt(qualityInput.value, 10) || 2;
            if (qualityLabel) qualityLabel.textContent = qualityLabels[v] || 'Medium';
            try { sessionStorage.setItem('mapfree_quality', qualityMap[v] || 'medium'); } catch (_) {}
        });
        var q = parseInt(qualityInput.value, 10) || 2;
        if (qualityLabel) qualityLabel.textContent = qualityLabels[q] || 'Medium';
    }
    fetch('/api/hardware/recommend').then(function(r) { return r.json(); }).then(function(h) {
        var rec = h.recommended_quality || 'medium';
        var slot = qualityToSlot[rec] || 2;
        var vramMb = h.vram_mb || 0;
        var vramStr = vramMb >= 1024 ? (vramMb / 1024).toFixed(1) + ' GB' : vramMb + ' MB';
        if (recommendEl) recommendEl.textContent = 'Rekomendasi otomatis: ' + (qualityLabels[slot] || rec) + ' (' + (vramMb ? vramStr + ' VRAM' : 'tanpa GPU') + ')';
        var hasStored = false;
        try { hasStored = !!sessionStorage.getItem('mapfree_quality'); } catch (_) {}
        if (!hasStored) setQualityUI(slot, qualityLabels[slot], true);
    }).catch(function() {
        if (recommendEl) recommendEl.textContent = 'Smart scaling: gunakan High/Medium/Low sesuai VRAM.';
    });
    var btn = document.getElementById('start-processing-btn');
    if (!btn) return;
    function getQuality() {
        try { return sessionStorage.getItem('mapfree_quality') || 'medium'; } catch (_) { return 'medium'; }
    }
    btn.addEventListener('click', function() {
        var img = '', out = '';
        try {
            img = sessionStorage.getItem('mapfree_image_folder') || '';
            out = sessionStorage.getItem('mapfree_output_folder') || '';
        } catch (_) {}
        var quality = getQuality();
        function goToProcessing() { window.location.href = '{{ url_for("processing") }}'; }
        if (typeof pywebview !== 'undefined' && pywebview.api && typeof pywebview.api.start_mapping_process === 'function') {
            pywebview.api.start_mapping_process(img, out, quality).then(goToProcessing).catch(function(err) {
                if (typeof window.appendConsoleLog === 'function') window.appendConsoleLog('Start process: ' + (err && err.message ? err.message : String(err)), 'error');
                goToProcessing();
            });
        } else {
            fetch('/api/processing/start', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ image_folder: img, output_folder: out, quality: quality }) })
                .then(function() { goToProcessing(); })
                .catch(function() {
                    if (typeof window.appendConsoleLog === 'function') window.appendConsoleLog('Gagal memulai proses. Isi Image Folder dan Output Folder di New Project.', 'error');
                    goToProcessing();
                });
        }
    });
})();
</script>
{% endblock %}
