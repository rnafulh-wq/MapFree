<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>{% block title %}MapFree Photogrammetry{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;family=JetBrains+Mono:wght@400;500&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#eb7500",
                        "primary-hover": "#d16400",
                        "background-dark": "#242424",
                        "surface-dark": "#333333",
                        "surface-lighter": "#404040",
                        "border-dark": "#4a4a4a",
                        "text-main": "#f3f3f3",
                        "text-muted": "#a0a0a0",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"],
                        "mono": ["JetBrains Mono", "monospace"],
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "sm": "0.2rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #242424; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #777; }
        input[type="checkbox"]:checked {
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        }
    </style>
    {% block head %}{% endblock %}
</head>
<body class="bg-background-dark text-text-main font-display antialiased overflow-hidden h-screen flex flex-col">
    <!-- Top Navigation Bar -->
    <header class="h-12 bg-surface-dark border-b border-border-dark flex items-center justify-between px-4 shrink-0 z-20">
        <div class="flex items-center gap-6">
            <a href="{{ url_for('dashboard') }}" class="flex items-center gap-2">
                <span class="material-symbols-outlined text-primary text-2xl">grid_view</span>
                <h1 class="text-sm font-bold tracking-tight text-white uppercase">MapFree <span class="text-text-muted font-normal normal-case ml-1">v2.4.1</span></h1>
            </a>
            <nav class="hidden md:flex items-center gap-1">
                <a href="{{ url_for('project_new') }}" class="px-3 py-1 text-xs font-medium {{ 'text-white bg-surface-lighter' if request.endpoint == 'project_new' else 'text-text-muted hover:text-white hover:bg-surface-lighter' }} rounded transition-colors">File</a>
                <a href="{{ url_for('settings') }}" class="px-3 py-1 text-xs font-medium {{ 'text-white bg-surface-lighter' if request.endpoint == 'settings' else 'text-text-muted hover:text-white hover:bg-surface-lighter' }} rounded transition-colors">Edit</a>
                <a href="{{ url_for('processing') }}" class="px-3 py-1 text-xs font-medium {{ 'text-white bg-surface-lighter' if request.endpoint == 'processing' else 'text-text-muted hover:text-white hover:bg-surface-lighter' }} rounded transition-colors">Process</a>
                <a href="{{ url_for('map_view') }}" class="px-3 py-1 text-xs font-medium {{ 'text-white bg-surface-lighter' if request.endpoint == 'map_view' else 'text-text-muted hover:text-white hover:bg-surface-lighter' }} rounded transition-colors">View</a>
                <a href="#" class="px-3 py-1 text-xs font-medium text-text-muted hover:text-white hover:bg-surface-lighter rounded transition-colors">Help</a>
            </nav>
        </div>
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2 bg-black/20 px-3 py-1 rounded text-xs text-text-muted font-mono border border-white/5">
                <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                GPU: Detected
            </div>
            <div class="w-8 h-8 rounded-full bg-surface-lighter flex items-center justify-center border border-white/10"></div>
        </div>
    </header>

    <!-- Main Workspace Area -->
    <main class="flex-1 flex overflow-hidden">
        <!-- Left Sidebar: Project Assets -->
        <aside class="w-72 bg-surface-dark border-r border-border-dark flex flex-col shrink-0 z-10 shadow-xl">
            <div class="p-3 border-b border-border-dark flex items-center justify-between">
                <h2 class="text-xs font-semibold uppercase tracking-wider text-text-muted">Project Assets</h2>
                <button type="button" id="add-images-btn" class="text-text-muted hover:text-white transition-colors" title="Add Images / Browse folder"><span class="material-symbols-outlined text-sm">add</span></button>
            </div>
            <div class="flex-1 overflow-y-auto p-2 space-y-1">
                <div class="group">
                    <a href="{{ url_for('dashboard') }}" class="flex items-center gap-2 px-2 py-1.5 hover:bg-surface-lighter rounded cursor-pointer select-none">
                        <span class="material-symbols-outlined text-text-muted text-sm group-hover:text-white">expand_more</span>
                        <span class="material-symbols-outlined text-primary text-sm">photo_camera</span>
                        <span class="text-sm font-medium flex-1">Cameras</span>
                    </a>
                </div>
                <div class="group">
                    <a href="{{ url_for('gcp') }}" class="flex items-center gap-2 px-2 py-1.5 hover:bg-surface-lighter rounded cursor-pointer select-none">
                        <span class="material-symbols-outlined text-text-muted text-sm group-hover:text-white">expand_more</span>
                        <span class="material-symbols-outlined text-blue-400 text-sm">grain</span>
                        <span class="text-sm font-medium flex-1">Tie Points / GCP</span>
                    </a>
                </div>
                <div class="group">
                    <div class="flex items-center gap-2 px-2 py-1.5 hover:bg-surface-lighter rounded cursor-pointer select-none">
                        <span class="material-symbols-outlined text-text-muted text-sm group-hover:text-white">chevron_right</span>
                        <span class="material-symbols-outlined text-purple-400 text-sm">layers</span>
                        <span class="text-sm font-medium flex-1">Depth Maps</span>
                    </div>
                </div>
                <div class="group">
                    <a href="{{ url_for('processing') }}" class="flex items-center gap-2 px-2 py-1.5 hover:bg-surface-lighter rounded cursor-pointer select-none">
                        <span class="material-symbols-outlined text-text-muted text-sm group-hover:text-white">expand_more</span>
                        <span class="material-symbols-outlined text-primary text-sm">cloud</span>
                        <span class="text-sm font-medium flex-1">Dense Cloud / Processing</span>
                    </a>
                </div>
                <div class="group">
                    <div class="flex items-center gap-2 px-2 py-1.5 hover:bg-surface-lighter rounded cursor-pointer select-none">
                        <span class="material-symbols-outlined text-text-muted text-sm group-hover:text-white">chevron_right</span>
                        <span class="material-symbols-outlined text-teal-400 text-sm">view_in_ar</span>
                        <span class="text-sm font-medium flex-1">3D Model</span>
                    </div>
                </div>
                <div class="group">
                    <a href="{{ url_for('export_view') }}" class="flex items-center gap-2 px-2 py-1.5 hover:bg-surface-lighter rounded cursor-pointer select-none">
                        <span class="material-symbols-outlined text-text-muted text-sm group-hover:text-white">chevron_right</span>
                        <span class="material-symbols-outlined text-yellow-400 text-sm">map</span>
                        <span class="text-sm font-medium flex-1">Orthomosaic</span>
                    </a>
                </div>
            </div>
            <div class="h-48 border-t border-border-dark bg-[#2a2a2a] flex flex-col">
                <div class="px-3 py-2 bg-surface-dark border-b border-border-dark flex justify-between items-center">
                    <span class="text-[10px] font-bold uppercase text-text-muted">Selected Image Metadata</span>
                </div>
                <div class="overflow-auto flex-1 p-2 text-[10px] text-text-muted font-mono">No image selected.</div>
            </div>
        </aside>

        <!-- Page Content (center + optional right panel) -->
        {% block content %}{% endblock %}
    </main>

    <!-- Console Output Panel (every page) -->
    <div class="h-40 bg-[#1e1e1e] border-t border-border-dark flex flex-col shrink-0">
        <div class="px-4 py-1.5 bg-surface-dark border-b border-border-dark flex justify-between items-center select-none cursor-row-resize">
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 text-xs font-semibold uppercase tracking-wider text-primary">
                    <span class="material-symbols-outlined text-sm">terminal</span>
                    Console Output
                </div>
                <div class="h-3 w-px bg-white/10"></div>
                <span id="console-errors" class="flex items-center gap-2 text-xs text-text-muted hover:text-white cursor-pointer"><span class="w-2 h-2 rounded-full bg-red-500"></span> Errors (0)</span>
                <span id="console-warnings" class="flex items-center gap-2 text-xs text-text-muted hover:text-white cursor-pointer"><span class="w-2 h-2 rounded-full bg-yellow-500"></span> Warnings (0)</span>
            </div>
            <div class="flex items-center gap-2">
                <button type="button" id="console-clear" class="text-text-muted hover:text-white" title="Clear Log"><span class="material-symbols-outlined text-sm">block</span></button>
                <button type="button" id="console-toggle" class="text-text-muted hover:text-white" title="Minimize"><span class="material-symbols-outlined text-sm">keyboard_arrow_down</span></button>
            </div>
        </div>
        <div id="console-output" class="flex-1 overflow-y-auto p-2 font-mono text-xs space-y-1 custom-scrollbar">
            <div class="flex gap-3 text-text-muted"><span class="text-gray-500 select-none">[--:--:--]</span><span>Console ready. Logs will appear here.</span></div>
        </div>
    </div>

    <script>
        // Real-time console: call from Python via SSE or from JS
        window.appendConsoleLog = function(msg, level) {
            level = level || 'info';
            var container = document.getElementById('console-output');
            if (!container) return;
            var time = new Date();
            var timeStr = time.toTimeString().slice(0, 8);
            var cls = 'text-text-muted';
            if (level === 'error') cls = 'text-red-400';
            else if (level === 'warn' || level === 'warning') cls = 'text-yellow-500/80';
            else if (level === 'success') cls = 'text-primary';
            var line = document.createElement('div');
            line.className = 'flex gap-3 ' + cls;
            line.innerHTML = '<span class="text-gray-500 select-none">[' + timeStr + ']</span><span>' + (msg || '').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</span>';
            container.appendChild(line);
            container.scrollTop = container.scrollHeight;
        };
        document.getElementById('console-clear').addEventListener('click', function() {
            var container = document.getElementById('console-output');
            if (container) container.innerHTML = '';
        });
        document.getElementById('console-toggle').addEventListener('click', function() {
            var panel = this.closest('.shrink-0');
            var body = panel.querySelector('#console-output');
            if (body) body.style.display = body.style.display === 'none' ? '' : 'none';
        });
        // Optional: connect to Python log stream (SSE)
        (function connectConsoleStream() {
            if (typeof EventSource === 'undefined') return;
            try {
                var es = new EventSource('/api/console/stream');
                es.onmessage = function(e) {
                    var d = {};
                    try { d = JSON.parse(e.data); } catch (_) { d = { msg: e.data, level: 'info' }; }
                    if (window.appendConsoleLog) window.appendConsoleLog(d.msg || d.message, d.level);
                };
                es.onerror = function() { es.close(); };
            } catch (_) {}
        })();
        // Native folder picker (pywebview): Add / Browse button
        window.addEventListener('pywebviewready', function() {
            var btn = document.getElementById('add-images-btn');
            if (!btn) return;
            btn.addEventListener('click', function() {
                if (typeof pywebview === 'undefined' || !pywebview.api || !pywebview.api.select_folder) return;
                pywebview.api.select_folder().then(function(path) {
                    if (path) {
                        window.mapfreeSelectedFolder = path;
                        if (typeof window.appendConsoleLog === 'function') window.appendConsoleLog('Folder selected: ' + path, 'success');
                    }
                }).catch(function(err) {
                    if (typeof window.appendConsoleLog === 'function') window.appendConsoleLog('Folder dialog: ' + (err && err.message ? err.message : String(err)), 'error');
                });
            });
        });
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>
